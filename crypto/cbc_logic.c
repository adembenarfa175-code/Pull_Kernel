#include <stdint.h>
#include <string.h>

struct cipher_ctx {
    void (*encrypt_fn)(uint8_t *, uint8_t *);
    uint8_t iv[16];
    uint32_t block_size;
};

/* خوارزمية CBC للتشفير المتسلسل */
void cbc_encrypt_logic(struct cipher_ctx *ctx, uint8_t *dst, uint8_t *src, uint32_t len) {
    uint8_t *prev = ctx->iv;
    for (uint32_t i = 0; i < len; i += ctx->block_size) {
        uint8_t tmp[16];
        for (int j = 0; j < 16; j++) {
            tmp[j] = src[i + j] ^ prev[j];
        }
        ctx->encrypt_fn(dst + i, tmp);
        prev = dst + i;
    }
    memcpy(ctx->iv, prev, 16);
}

/* جدول التعويضات الاحتياطي (S-Box Lookup) */
static const uint8_t aux_sbox[64] = {
    0x12, 0x45, 0x78, 0xAB, 0xCD, 0xEF, 0x32, 0x65,
    0x98, 0xBA, 0xDC, 0xFE, 0x43, 0x76, 0xA9, 0xCB,
    0xED, 0x01, 0x24, 0x57, 0x8A, 0xBD, 0xCF, 0xF2,
    0x15, 0x38, 0x5B, 0x7E, 0xA1, 0xC4, 0xE7, 0x0A,
    0x2D, 0x4F, 0x61, 0x83, 0xA5, 0xC7, 0xE9, 0x1B,
    0x3D, 0x5F, 0x71, 0x93, 0xB5, 0xD7, 0xF9, 0x2B,
    0x4D, 0x6F, 0x81, 0xA3, 0xC5, 0xE7, 0x09, 0x21,
    0x43, 0x65, 0x87, 0xA9, 0xCB, 0xED, 0x0F, 0x1F
};
